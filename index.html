<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Tati Arcade ‚Äî GBA Quest</title>
  <style>
    :root{
      --bd:rgba(255,255,255,.18);
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      background:#0b0f1a;
      overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:#fff;
    }
    canvas{ width:100vw; height:100vh; display:block; image-rendering: pixelated; }

    /* Emulator-like HUD bar */
    .hudTop{
      position:fixed; left:0; right:0; top:0;
      z-index:10;
      padding:10px 12px;
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      pointer-events:none;
      background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.10));
      border-bottom:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(8px);
    }
    .hudTop .left, .hudTop .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .chip{
      pointer-events:auto;
      padding:7px 10px;
      border-radius:14px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:#fff;
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }

    /* Dialog (Pok√©mon box) */
    .dialog{
      position:fixed; left:14px; right:14px; bottom:14px;
      z-index:30;
      border-radius:14px;
      border:2px solid rgba(255,255,255,.35);
      background:linear-gradient(180deg, rgba(0,0,0,.50), rgba(0,0,0,.35));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px;
      display:none;
    }
    .dialog .name{font-weight:1000; margin-bottom:6px}
    .dialog .text{color:rgba(255,255,255,.95); line-height:1.4}
    .dialog .hint{margin-top:10px; color:rgba(255,255,255,.70); font-size:12px}

    /* Prompt modal */
    .prompt{
      position:fixed; inset:0;
      z-index:50;
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      background:rgba(0,0,0,.60);
      backdrop-filter: blur(6px);
    }
    .promptCard{
      width:min(520px,100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:16px;
    }
    .promptCard h2{margin:0; font-size:18px}
    .promptCard p{margin:10px 0 0; color:rgba(255,255,255,.78); line-height:1.45}
    .promptRow{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .promptCard input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:#fff;
      font-weight:1000;
      letter-spacing:.8px;
      outline:none;
      text-transform: uppercase;
    }
    .msg{ margin-top:10px; font-weight:1000; display:none; }
    .msg.ok{ color:#bfffe2; }
    .msg.bad{ color:#ffd0d8; }

    /* Touch controls (only mobile) */
    .touch{
      position:fixed; inset:0;
      z-index:20;
      pointer-events:none;
    }
    .dpad{
      position:absolute; left:16px; bottom:20px;
      width:170px; height:170px;
      border-radius:22px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      pointer-events:auto;
      touch-action:none;
    }
    .dpad .cross{ position:absolute; inset:22px; border-radius:16px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); }
    .dpad .nub{
      position:absolute; left:50%; top:50%;
      width:66px; height:66px;
      transform:translate(-50%,-50%);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(184,107,255,.95), rgba(255,92,200,.75));
      border:1px solid rgba(255,255,255,.20);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .ab{
      position:absolute; right:16px; bottom:36px;
      display:flex; gap:12px; align-items:flex-end;
      pointer-events:auto;
    }
    .ab button{
      border:none; cursor:pointer;
      border-radius:999px;
      width:84px; height:84px;
      font-weight:1000; font-size:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      touch-action:none;
    }
    .ab .a{ background:linear-gradient(180deg, rgba(82,255,168,.95), rgba(82,255,168,.70)); color:#062014; }
    .ab .b{ background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); color:#fff; width:70px; height:70px; margin-bottom:8px; }

    .menuRow{
      position:absolute; left:50%; bottom:18px;
      transform:translateX(-50%);
      display:flex; gap:10px;
      pointer-events:auto;
    }
    .menuRow button{
      width:84px; height:38px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.16);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    @media (min-width: 900px){ .touch{display:none} }

    /* Confetti */
    #confetti{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:60}

    /* WIN overlay */
    .pixel{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      letter-spacing: .5px; text-transform: uppercase;
    }
    .winOverlay{
      position:fixed; inset:0;
      display:none;
      z-index:80;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(6px);
      padding: 18px;
      align-items:center;
      justify-content:center;
    }
    .winCard{
      width:min(520px, 100%);
      border: 4px solid rgba(255,255,255,.85);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      background: #000;
    }
    .winSky{
      position:relative;
      height: 320px;
      background: linear-gradient(#79c8ff, #79c8ff);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .cloud{
      position:absolute;
      width: 92px; height: 36px;
      background: rgba(255,255,255,.92);
      border-radius: 8px;
      opacity:.85;
    }
    .cloud:before, .cloud:after{
      content:"";
      position:absolute;
      background: rgba(255,255,255,.92);
      border-radius: 10px;
    }
    .cloud:before{ width:46px; height:26px; left:-18px; top:10px; }
    .cloud:after{ width:52px; height:28px; right:-16px; top:6px; }
    .c1{ top:34px; left:18px; transform:scale(1.05); }
    .c2{ top:64px; right:22px; transform:scale(.95); }
    .c3{ bottom:88px; left:44px; transform:scale(.9); }

    .winText{
      position:absolute;
      top: 124px;
      left:0; right:0;
      text-align:center;
      font-weight: 1000;
      color: #ffd36a;
      text-shadow: 0 3px 0 rgba(0,0,0,.55);
      font-size: 28px;
    }
    .trophyBtn{
      width: 110px;
      height: 110px;
      border: 4px solid rgba(0,0,0,.35);
      border-radius: 14px;
      background: linear-gradient(180deg, #ffd36a, #ffb84b);
      box-shadow: 0 10px 0 rgba(0,0,0,.25), 0 18px 40px rgba(0,0,0,.25);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      position:absolute;
      top: 34px;
      left:50%;
      transform: translateX(-50%);
      transition: transform .08s ease;
    }
    .trophyBtn:active{ transform: translateX(-50%) scale(.98); }
    .trophyIcon{ font-size:56px; filter: drop-shadow(0 3px 0 rgba(0,0,0,.25)); }
    .winGround{
      padding: 14px;
      background: linear-gradient(180deg, rgba(184,107,255,.18), rgba(255,92,200,.10));
      border-top: 4px solid rgba(255,255,255,.35);
    }
    .winHint{
      color: rgba(255,255,255,.90);
      font-weight: 900;
      text-align:center;
      margin: 0;
      font-size: 13px;
    }
    .winModal{
      margin-top: 12px;
      display:none;
      padding: 14px;
      border: 2px dashed rgba(255,255,255,.55);
      border-radius: 14px;
      background: rgba(0,0,0,.35);
    }
    .winQ{
      margin:0;
      color:#fff;
      font-weight:1000;
      font-size: 16px;
      text-align:center;
      text-transform:none; letter-spacing:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .winSub{
      margin:10px 0 0;
      text-align:center;
      color: rgba(255,255,255,.75);
      font-size: 12px;
      line-height:1.4;
      text-transform:none; letter-spacing:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .winBtns{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 12px;}
    .winYes{
      border:none; border-radius: 14px;
      padding: 10px 14px;
      font-weight:1000; cursor:pointer;
      background: linear-gradient(180deg, rgba(184,107,255,.98), rgba(255,92,200,.85));
      color:#190424;
    }
    .winYes:active{ transform: scale(.98); }
    .winClose{
      border:1px solid rgba(255,255,255,.25);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:900; cursor:pointer;
      background: rgba(255,255,255,.10);
      color:#fff;
    }
  </style>
</head>
<body>
  <div class="hudTop">
    <div class="left">
      <div class="chip">üîä <span id="sndTxt">OFF</span></div>
      <div class="chip">üö™ <span id="progTxt">0/3</span></div>
      <div class="chip">üß© <span id="invTxt">‚Äî</span></div>
      <div class="chip">‚å®Ô∏è PC: WASD/Flechas ¬∑ E/Enter</div>
    </div>
    <div class="right">
      <button class="btn" id="soundBtn">Sound</button>
      <button class="btn" id="pauseBtn">Pause</button>
      <button class="btn" id="resetBtn">Restart</button>
    </div>
  </div>

  <canvas id="c"></canvas>
  <canvas id="confetti"></canvas>

  <div class="dialog" id="dialog">
    <div class="name" id="dName">NPC</div>
    <div class="text" id="dText">Texto‚Ä¶</div>
    <div class="hint" id="dHint">E/Enter pa‚Äô seguir ¬∑ Esc pa‚Äô cerrar</div>
  </div>

  <div class="prompt" id="prompt">
    <div class="promptCard">
      <h2 id="pTitle">Checkpoint</h2>
      <p id="pBody">Escribe la clave del papel.</p>
      <div class="promptRow">
        <input id="pInput" autocomplete="off" autocapitalize="characters" placeholder="ESCRIBE AQU√ç‚Ä¶" />
      </div>
      <div class="promptRow">
        <button class="btn" id="pOk">Validar</button>
        <button class="btn" id="pCancel">Cancelar</button>
      </div>
      <div class="msg" id="pMsg"></div>
    </div>
  </div>

  <div class="touch" aria-hidden="true">
    <div class="dpad" id="dpad">
      <div class="cross"></div>
      <div class="nub" id="nub"></div>
    </div>
    <div class="ab">
      <button class="b" id="bBtn">B</button>
      <button class="a" id="aBtn">A</button>
    </div>
    <div class="menuRow">
      <button id="selBtn">SELECT</button>
      <button id="staBtn">START</button>
    </div>
  </div>

  <div class="winOverlay" id="winOverlay">
    <div class="winCard">
      <div class="winSky">
        <div class="cloud c1"></div><div class="cloud c2"></div><div class="cloud c3"></div>
        <button class="trophyBtn" id="trophyBtn"><div class="trophyIcon">üèÜ</div></button>
        <div class="winText pixel">YOU WIN!</div>
      </div>
      <div class="winGround">
        <p class="winHint pixel">TAP THE TROPHY</p>
        <div class="winModal" id="winModal">
          <p class="winQ">Tati‚Ä¶ ¬øquieres ser mi novia?</p>
          <p class="winSub">‚ÄúAcepto tus bugs y celebro tus versiones.‚Äù</p>
          <div class="winBtns">
            <button class="winYes" id="winYes1">S√≠</button>
            <button class="winYes" id="winYes2">S√≠</button>
            <button class="winClose" id="winClose">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Canvas =====
  const c = document.getElementById('c');
  const ctx = c.getContext('2d');
  const conf = document.getElementById('confetti');
  const cctx = conf.getContext('2d');

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    c.width = Math.floor(window.innerWidth * dpr);
    c.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    conf.width = Math.floor(window.innerWidth * dpr);
    conf.height = Math.floor(window.innerHeight * dpr);
    cctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  // ===== UI refs =====
  const sndTxt = document.getElementById('sndTxt');
  const progTxt = document.getElementById('progTxt');
  const invTxt = document.getElementById('invTxt');
  const soundBtn = document.getElementById('soundBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');

  const dialog = document.getElementById('dialog');
  const dName = document.getElementById('dName');
  const dText = document.getElementById('dText');
  const dHint = document.getElementById('dHint');

  const prompt = document.getElementById('prompt');
  const pTitle = document.getElementById('pTitle');
  const pBody = document.getElementById('pBody');
  const pInput = document.getElementById('pInput');
  const pOk = document.getElementById('pOk');
  const pCancel = document.getElementById('pCancel');
  const pMsg = document.getElementById('pMsg');

  const winOverlay = document.getElementById('winOverlay');
  const trophyBtn = document.getElementById('trophyBtn');
  const winModal = document.getElementById('winModal');
  const winYes1 = document.getElementById('winYes1');
  const winYes2 = document.getElementById('winYes2');
  const winClose = document.getElementById('winClose');

  // ===== Audio =====
  let soundOn = false;
  let audioCtx = null;
  function beep(freq=440, dur=0.06, type='square', vol=0.05){
    if(!soundOn) return;
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(), dur*1000);
  }
  soundBtn.addEventListener('click', ()=>{
    soundOn = !soundOn;
    sndTxt.textContent = soundOn ? 'ON' : 'OFF';
    beep(740,0.08);
  });

  // ===== Controls =====
  const keys = {up:false,down:false,left:false,right:false,act:false,back:false};
  let paused = false;

  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup'||k==='w') keys.up=true;
    if(k==='arrowdown'||k==='s') keys.down=true;
    if(k==='arrowleft'||k==='a') keys.left=true;
    if(k==='arrowright'||k==='d') keys.right=true;
    if(k==='e'||k==='enter') keys.act=true;
    if(k==='escape') keys.back=true;
    if(k==='p') paused = !paused;
  });
  window.addEventListener('keyup', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup'||k==='w') keys.up=false;
    if(k==='arrowdown'||k==='s') keys.down=false;
    if(k==='arrowleft'||k==='a') keys.left=false;
    if(k==='arrowright'||k==='d') keys.right=false;
    if(k==='e'||k==='enter') keys.act=false;
    if(k==='escape') keys.back=false;
  });

  pauseBtn.addEventListener('click', ()=> paused = !paused);
  resetBtn.addEventListener('click', ()=> resetGame());

  // ===== Touch controls (mobile) =====
  const dpad = document.getElementById('dpad');
  const nub = document.getElementById('nub');
  const aBtn = document.getElementById('aBtn');
  const bBtn = document.getElementById('bBtn');
  const staBtn = document.getElementById('staBtn');

  let dpadActive=false, dpadId=null;
  let dvec={x:0,y:0};
  const dRadius = 54;

  dpad.addEventListener('pointerdown', (e)=>{
    dpadActive=true; dpadId=e.pointerId; dpad.setPointerCapture(dpadId);
    moveDpad(e);
  });
  dpad.addEventListener('pointermove', (e)=>{ if(dpadActive && e.pointerId===dpadId) moveDpad(e); });
  dpad.addEventListener('pointerup', (e)=>{ if(e.pointerId===dpadId) resetDpad(); });
  dpad.addEventListener('pointercancel', ()=>resetDpad());

  function moveDpad(e){
    const r = dpad.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    const dx = e.clientX - cx;
    const dy = e.clientY - cy;
    const len = Math.hypot(dx,dy) || 1;
    const k = Math.min(1, len/dRadius);
    dvec.x = (dx/len)*k;
    dvec.y = (dy/len)*k;
    nub.style.transform = `translate(calc(-50% + ${dvec.x*dRadius}px), calc(-50% + ${dvec.y*dRadius}px))`;
  }
  function resetDpad(){
    dpadActive=false; dpadId=null; dvec={x:0,y:0};
    nub.style.transform = `translate(-50%,-50%)`;
  }

  aBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); keys.act=true; });
  aBtn.addEventListener('pointerup', (e)=>{ e.preventDefault(); keys.act=false; });
  aBtn.addEventListener('pointercancel', ()=>{ keys.act=false; });

  bBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); keys.back=true; });
  bBtn.addEventListener('pointerup', (e)=>{ e.preventDefault(); keys.back=false; });
  bBtn.addEventListener('pointercancel', ()=>{ keys.back=false; });

  staBtn.addEventListener('click', ()=> paused = !paused);

  // ===== Helpers =====
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const dist=(ax,ay,bx,by)=>Math.hypot(ax-bx, ay-by);

  // ===== Map: more like Pok√©mon screenshot =====
  const TILE = 24;
  const MAP_W = 40;
  const MAP_H = 26;

  // tile types:
  // 0 grass, 1 solid (water/edge), 2 path, 3 tall grass, 4 flower, 5 fence,
  // 6 sign, 7 npcZone, 8 gateLocked, 9 gateOpen, 10 house
  const map = Array.from({length:MAP_H}, ()=>Array.from({length:MAP_W}, ()=>0));

  // borders water-ish
  for(let y=0;y<MAP_H;y++){
    for(let x=0;x<MAP_W;x++){
      if(x===0||y===0||x===MAP_W-1||y===MAP_H-1) map[y][x]=1;
    }
  }

  // path strip like screenshot (horizontal)
  for(let x=2; x<MAP_W-2; x++){
    map[12][x]=2;
    map[13][x]=2;
  }

  // fences bottom
  for(let x=2; x<MAP_W-2; x++){
    map[22][x]=5;
  }

  // tall grass patches
  for(let y=15;y<21;y++){
    for(let x=3;x<13;x++) map[y][x]=3;
  }
  for(let y=15;y<21;y++){
    for(let x=27;x<37;x++) map[y][x]=3;
  }

  // flowers
  const flowers=[[6,18],[7,18],[6,19],[30,18],[31,18],[30,19]];
  flowers.forEach(([x,y])=>map[y][x]=4);

  // sign on path
  map[12][8]=6;

  // houses (blocks)
  function placeHouse(x0,y0){
    for(let y=y0; y<y0+4; y++){
      for(let x=x0; x<x0+6; x++){
        map[y][x]=10;
      }
    }
  }
  placeHouse(4,4);
  placeHouse(30,4);

  // fences around houses
  for(let x=3;x<12;x++) map[9][x]=5;
  for(let y=5;y<9;y++) map[y][3]=5;
  for(let y=5;y<9;y++) map[y][11]=5;

  for(let x=29;x<38;x++) map[9][x]=5;
  for(let y=5;y<9;y++) map[y][29]=5;
  for(let y=5;y<9;y++) map[y][37]=5;

  // gates locked on path after checkpoints
  map[12][16]=8; map[13][16]=8; // gate1
  map[12][24]=8; map[13][24]=8; // gate2
  map[12][34]=8; map[13][34]=8; // gate3

  function isSolid(t){
    return (t===1 || t===5 || t===8 || t===10);
  }

  // ===== NPCs (characters) =====
  const NPCS = [
    {id:'tati', name:'Tati', x:10*TILE, y:10*TILE, color:'#b86bff',
      lines:[
        "Holaa üôÇ",
        "Tengo una misi√≥n pa‚Äô ti.",
        "Trae las 3 claves del mundo real üòè"
      ]},
    {id:'npc1', name:'Vecino', x:20*TILE, y:10*TILE, color:'#ffd36a',
      lines:[
        "Ese letrero del camino‚Ä¶",
        "tiene un checkpoint bien serio.",
        "Dale E/Enter pa‚Äô interactuar."
      ]},
    {id:'npc2', name:'Ni√±a', x:30*TILE, y:18*TILE, color:'#52ffa8',
      lines:[
        "O√≠ que las claves son 3‚Ä¶",
        "JUPITER, SPARK, y GT. üëÄ",
        "Pero t√∫ no o√≠ste eso de m√≠ üòÇ"
      ]},
  ];

  // ===== Checkpoints (your physical riddles answers) =====
  const ANSWERS = ["JUPITER","SPARK","GT"];
  const checkpoints = [
    {id:0, title:"Checkpoint 1", body:"Clave del papel #1", nearX:8*TILE, nearY:12*TILE, gateX:16, gateY:12},
    {id:1, title:"Checkpoint 2", body:"Clave del papel #2", nearX:20*TILE, nearY:12*TILE, gateX:24, gateY:12},
    {id:2, title:"Checkpoint 3", body:"Clave del papel #3", nearX:32*TILE, nearY:12*TILE, gateX:34, gateY:12},
  ];

  // ===== State =====
  let state;

  function resetGame(){
    hideWin();
    closePrompt();
    closeDialog();
    paused=false;
    state = {
      player:{x:6*TILE, y:16*TILE, face:'down', spd:150},
      cam:{x:0,y:0},
      unlocked:[false,false,false],
      keysFound:[],
      dialogQueue:[],
      aLatch:false,
      bLatch:false,
      promptOpen:false,
      win:false
    };
    updateHUD();
  }

  function updateHUD(){
    const done = state.unlocked.filter(Boolean).length;
    progTxt.textContent = `${done}/3`;
    invTxt.textContent = state.keysFound.length ? state.keysFound.join(' ¬∑ ') : '‚Äî';
  }

  // ===== Dialog =====
  function openDialog(name, lines){
    state.dialogQueue = lines.slice();
    dName.textContent = name;
    dHint.textContent = "E/Enter pa‚Äô seguir ¬∑ Esc pa‚Äô cerrar";
    dialog.style.display='block';
    nextLine();
  }
  function nextLine(){
    const line = state.dialogQueue.shift();
    if(!line){ closeDialog(); return; }
    dText.textContent = line;
    beep(660,0.03,'square',0.03);
  }
  function closeDialog(){
    dialog.style.display='none';
    state.dialogQueue = [];
  }

  // ===== Prompt =====
  let currentCP = -1;
  function openPrompt(cpId){
    currentCP = cpId;
    state.promptOpen = true;
    prompt.style.display='flex';
    pInput.value='';
    pMsg.style.display='none';
    pTitle.textContent = checkpoints[cpId].title;
    pBody.textContent = checkpoints[cpId].body;
    setTimeout(()=>pInput.focus(), 50);
  }
  function closePrompt(){
    prompt.style.display='none';
    state.promptOpen = false;
    currentCP = -1;
  }
  function setPromptMsg(text, ok){
    pMsg.style.display='block';
    pMsg.textContent = text;
    pMsg.className = `msg ${ok?'ok':'bad'}`;
  }

  pCancel.addEventListener('click', closePrompt);
  pOk.addEventListener('click', validatePrompt);
  pInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') validatePrompt();
    if(e.key === 'Escape') closePrompt();
  });

  function unlockGate(i){
    if(state.unlocked[i]) return;
    state.unlocked[i] = true;
    state.keysFound.push(ANSWERS[i]);
    updateHUD();
    // convert locked gate tiles to open
    const gx = checkpoints[i].gateX;
    map[12][gx]=9; map[13][gx]=9;
    burstConfetti(90);
    beep(880,0.08);
  }

  function validatePrompt(){
    if(currentCP < 0) return;
    const got = (pInput.value||'').trim().toUpperCase();
    const expected = ANSWERS[currentCP];
    if(got === expected){
      setPromptMsg("‚úÖ Correcto. Puerta desbloqueada.", true);
      unlockGate(currentCP);
      setTimeout(()=>{
        closePrompt();
        openDialog("Sistema", [
          `Clave aceptada: ${expected}`,
          "Sigue por el camino üòâ"
        ]);
      }, 380);
    } else {
      beep(220,0.08);
      setPromptMsg("‚ùå Nope. Revisa tu adivinanza del papel.", false);
    }
  }

  // ===== Win =====
  function showWin(){
    paused = true;
    state.win = true;
    winModal.style.display = 'none';
    winOverlay.style.display = 'flex';
    burstConfetti(180);
    beep(980,0.10);
  }
  function hideWin(){
    winOverlay.style.display='none';
    winModal.style.display='none';
  }
  trophyBtn.addEventListener('click', ()=>{
    winModal.style.display = (winModal.style.display === 'block') ? 'none' : 'block';
    beep(740,0.06);
  });
  function yesAction(){
    burstConfetti(220);
    beep(880,0.10);
    alert("üíú Girlfriend_mode = true ‚úÖ");
  }
  winYes1.addEventListener('click', yesAction);
  winYes2.addEventListener('click', yesAction);
  winClose.addEventListener('click', hideWin);

  // ===== Confetti =====
  let confetti = [];
  function piece(){
    const colors = ['#b86bff','#ff5cc8','#ffffff','#52ffa8','#ffd36a'];
    return {
      x:rnd(0, window.innerWidth),
      y:-20-rnd(0,120),
      vx:rnd(-120,120),
      vy:rnd(140,320),
      r:rnd(6,12),
      rot:rnd(0,Math.PI),
      vr:rnd(-2,2),
      c:colors[Math.floor(rnd(0,colors.length))],
      life:rnd(1.2, 2.4)
    };
  }
  function burstConfetti(n=160){
    confetti = confetti.concat(Array.from({length:n}, piece));
  }
  function drawConfetti(){
    if(confetti.length===0) { cctx.clearRect(0,0,window.innerWidth,window.innerHeight); return; }
    cctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    const dt = 1/60;
    confetti.forEach(p=>{
      p.life -= dt;
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 120*dt;
      p.rot += p.vr*dt;
      cctx.save();
      cctx.translate(p.x,p.y);
      cctx.rotate(p.rot);
      cctx.fillStyle = p.c;
      cctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
      cctx.restore();
    });
    confetti = confetti.filter(p=>p.life>0 && p.y < window.innerHeight+40);
  }

  // ===== Movement =====
  function getMove(){
    let x=0,y=0;
    if(keys.left) x-=1;
    if(keys.right) x+=1;
    if(keys.up) y-=1;
    if(keys.down) y+=1;

    // add touch vector
    x += dvec.x;
    y += dvec.y;

    const l = Math.hypot(x,y);
    if(l < 0.2) return {x:0,y:0};
    return {x:x/l, y:y/l};
  }

  function tileAtWorld(x,y){
    const tx = Math.floor(x / TILE);
    const ty = Math.floor(y / TILE);
    if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) return {t:1, tx, ty};
    return {t: map[ty][tx], tx, ty};
  }

  function collides(px,py){
    const r=8;
    const corners = [
      {x:px-r,y:py-r},{x:px+r,y:py-r},{x:px-r,y:py+r},{x:px+r,y:py+r}
    ];
    return corners.some(c=>{
      const tx = Math.floor(c.x / TILE);
      const ty = Math.floor(c.y / TILE);
      const t = (map[ty] && map[ty][tx] !== undefined) ? map[ty][tx] : 1;
      return isSolid(t);
    });
  }

  function movePlayer(dt){
    const p = state.player;
    const mv = getMove();
    if(mv.x===0 && mv.y===0) return;

    if(Math.abs(mv.x) > Math.abs(mv.y)) p.face = (mv.x>0?'right':'left');
    else p.face = (mv.y>0?'down':'up');

    const spd = p.spd;
    const nx = p.x + mv.x*spd*dt;
    const ny = p.y + mv.y*spd*dt;

    if(!collides(nx,p.y)) p.x = nx;
    if(!collides(p.x,ny)) p.y = ny;

    p.x = clamp(p.x, TILE*1.2, TILE*(MAP_W-1.2));
    p.y = clamp(p.y, TILE*1.2, TILE*(MAP_H-1.2));
  }

  function updateCam(){
    const p = state.player;
    const targetX = p.x - window.innerWidth/2;
    const targetY = p.y - window.innerHeight/2;
    const maxX = MAP_W*TILE - window.innerWidth;
    const maxY = MAP_H*TILE - window.innerHeight;
    state.cam.x = clamp(targetX, 0, Math.max(0,maxX));
    state.cam.y = clamp(targetY, 0, Math.max(0,maxY));
  }

  // ===== Interactions =====
  function frontTile(){
    const p = state.player;
    let fx=0,fy=0;
    if(p.face==='up') fy=-1;
    if(p.face==='down') fy=1;
    if(p.face==='left') fx=-1;
    if(p.face==='right') fx=1;
    return tileAtWorld(p.x + fx*TILE*0.85, p.y + fy*TILE*0.85);
  }

  function tryInteract(){
    if(state.promptOpen) return;

    if(dialog.style.display==='block'){
      nextLine();
      return;
    }

    // NPC check
    for(const n of NPCS){
      if(dist(state.player.x,state.player.y,n.x,n.y) < 22){
        openDialog(n.name, n.lines);
        return;
      }
    }

    // checkpoint triggers by proximity (like talking to sign/terminal)
    for(const cp of checkpoints){
      if(dist(state.player.x,state.player.y,cp.nearX,cp.nearY) < 26){
        if(state.unlocked[cp.id]){
          openDialog("Sistema", ["Ese checkpoint ya est√° listo ‚úÖ", "Sigue pa‚Äô lante üòå"]);
        } else {
          openDialog("Checkpoint", ["Tienes una adivinanza en papel.", "Entra la clave aqu√≠."]);
          setTimeout(()=>openPrompt(cp.id), 150);
        }
        return;
      }
    }

    // if all unlocked & near final gate area -> win
    if(state.unlocked.every(Boolean)){
      if(dist(state.player.x,state.player.y, 36*TILE, 12*TILE) < 80){
        showWin();
        return;
      }
    }

    // sign tile interaction
    const ft = frontTile();
    if(ft.t===6){
      openDialog("Letrero", [
        "Checkpoint 1 est√° cerca.",
        "Busca tu papel #1 üòâ"
      ]);
      return;
    }

    openDialog("Sistema", ["No hay nada aqu√≠.", "Sigue explorando el mapa."]);
  }

  // ===== Input latches =====
  function tickInputs(){
    // act (E/Enter/A)
    if(keys.act && !state.aLatch){
      state.aLatch = true;
      tryInteract();
    }
    if(!keys.act) state.aLatch = false;

    // back (Esc/B) closes dialog/prompt
    if(keys.back && !state.bLatch){
      state.bLatch = true;
      if(state.promptOpen) closePrompt();
      else if(dialog.style.display==='block') closeDialog();
    }
    if(!keys.back) state.bLatch = false;
  }

  // ===== Drawing tiles (more GBA-ish) =====
  function drawTile(sx,sy,t){
    // Grass
    if(t===0){
      ctx.fillStyle = '#5fbf6b';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(0,0,0,.06)';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(255,255,255,.10)';
      ctx.fillRect(sx+4,sy+6,2,2);
      ctx.fillRect(sx+16,sy+14,2,2);
    }
    // Water border
    if(t===1){
      ctx.fillStyle = '#3aa0d8';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(255,255,255,.10)';
      ctx.fillRect(sx+6,sy+10,10,2);
      ctx.fillStyle = 'rgba(0,0,0,.12)';
      ctx.fillRect(sx,sy,TILE,3);
    }
    // Path
    if(t===2){
      ctx.fillStyle = '#e8d38a';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(0,0,0,.06)';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(255,255,255,.08)';
      ctx.fillRect(sx+3,sy+3,3,3);
    }
    // Tall grass
    if(t===3){
      ctx.fillStyle = '#4aa85a';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(0,0,0,.08)';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(255,255,255,.10)';
      ctx.fillRect(sx+4,sy+14,3,6);
      ctx.fillRect(sx+10,sy+10,3,10);
      ctx.fillRect(sx+16,sy+12,3,8);
    }
    // Flowers
    if(t===4){
      ctx.fillStyle = '#5fbf6b';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = '#ff5cc8';
      ctx.fillRect(sx+9,sy+9,6,6);
      ctx.fillStyle = '#ffd36a';
      ctx.fillRect(sx+11,sy+11,2,2);
    }
    // Fence
    if(t===5){
      ctx.fillStyle = '#8aa3b2';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(255,255,255,.18)';
      ctx.fillRect(sx+2,sy+4,TILE-4,4);
      ctx.fillRect(sx+2,sy+12,TILE-4,4);
      ctx.fillStyle = 'rgba(0,0,0,.18)';
      ctx.fillRect(sx+2,sy+TILE-6,TILE-4,4);
    }
    // Sign
    if(t===6){
      ctx.fillStyle = '#e8d38a';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = '#8a5a2b';
      ctx.fillRect(sx+8,sy+6,10,12);
      ctx.fillStyle = '#fff';
      ctx.fillRect(sx+9,sy+8,8,3);
      ctx.fillStyle = '#ff5cc8';
      ctx.fillRect(sx+9,sy+12,6,2);
    }
    // Gate locked
    if(t===8){
      ctx.fillStyle = '#e8d38a';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = '#2b2b2b';
      ctx.fillRect(sx+9,sy+3,6,18);
      ctx.fillStyle = '#ff5a78';
      ctx.fillRect(sx+8,sy+10,8,5);
      ctx.fillStyle = '#fff';
      ctx.fillRect(sx+10,sy+12,4,1);
    }
    // Gate open
    if(t===9){
      ctx.fillStyle = '#e8d38a';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = 'rgba(0,0,0,.05)';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = '#52ffa8';
      ctx.fillRect(sx+9,sy+3,6,18);
      ctx.fillStyle = '#fff';
      ctx.fillRect(sx+10,sy+12,4,1);
    }
    // House
    if(t===10){
      ctx.fillStyle = '#c98a52';
      ctx.fillRect(sx,sy,TILE,TILE);
      ctx.fillStyle = '#b85d5d';
      ctx.fillRect(sx,sy, TILE, 6);
      ctx.fillStyle = 'rgba(255,255,255,.10)';
      ctx.fillRect(sx+4,sy+8,6,6);
      ctx.fillRect(sx+14,sy+8,6,6);
    }
  }

  function drawMap(){
    const cam = state.cam;
    const startX = Math.floor(cam.x / TILE);
    const startY = Math.floor(cam.y / TILE);
    const endX = Math.ceil((cam.x + window.innerWidth) / TILE);
    const endY = Math.ceil((cam.y + window.innerHeight) / TILE);

    for(let y=startY; y<endY; y++){
      for(let x=startX; x<endX; x++){
        if(x<0||y<0||x>=MAP_W||y>=MAP_H) continue;
        const t = map[y][x];
        drawTile(x*TILE - cam.x, y*TILE - cam.y, t);
      }
    }

    // subtle vignette like handheld capture
    const grd = ctx.createRadialGradient(window.innerWidth/2, window.innerHeight/2, 140, window.innerWidth/2, window.innerHeight/2, Math.max(window.innerWidth,window.innerHeight));
    grd.addColorStop(0,'rgba(0,0,0,0)');
    grd.addColorStop(1,'rgba(0,0,0,.22)');
    ctx.fillStyle = grd;
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
  }

  // Pixel-ish sprite (player + NPCs)
  function drawSprite(x,y,shirtColor,hatColor){
    const cam = state.cam;
    const sx = x - cam.x;
    const sy = y - cam.y;

    // shadow
    ctx.fillStyle='rgba(0,0,0,.20)';
    ctx.beginPath();
    ctx.ellipse(sx, sy+10, 10, 5, 0, 0, Math.PI*2);
    ctx.fill();

    // body
    ctx.fillStyle = shirtColor;
    ctx.fillRect(sx-8, sy-16, 16, 16);
    ctx.fillStyle = '#2b2b2b';
    ctx.fillRect(sx-8, sy, 16, 14);

    // hat
    ctx.fillStyle = hatColor;
    ctx.fillRect(sx-9, sy-22, 18, 8);
    ctx.fillStyle = '#fff';
    ctx.fillRect(sx-4, sy-20, 8, 3);
  }

  function drawPlayer(){
    const p = state.player;
    drawSprite(p.x,p.y,'#d84b4b','#ff5a78');

    // direction dot
    const cam = state.cam;
    const sx = p.x - cam.x;
    const sy = p.y - cam.y;
    ctx.fillStyle = '#fff';
    const fx = p.face==='right'? 6 : p.face==='left'? -6 : 0;
    const fy = p.face==='down'? 4 : p.face==='up'? -4 : 0;
    ctx.fillRect(sx+fx-1, sy-6+fy-1, 2, 2);
  }

  function drawNPCs(){
    for(const n of NPCS){
      drawSprite(n.x,n.y,n.color,'#222');
      const cam = state.cam;
      const sx = n.x - cam.x;
      const sy = n.y - cam.y;
      if(dist(state.player.x,state.player.y,n.x,n.y) < 48){
        ctx.font='12px system-ui';
        ctx.textAlign='center';
        ctx.fillStyle='rgba(255,255,255,.90)';
        ctx.fillText(n.name, sx, sy-26);
      }
    }
  }

  // ===== Loop =====
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;

    if(!paused && !state.win){
      tickInputs();
      if(!state.promptOpen && dialog.style.display!=='block'){
        movePlayer(dt);
        updateCam();
      }
    }

    render();
    requestAnimationFrame(loop);
  }

  function render(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    // slight sky tint like screenshot
    ctx.fillStyle = 'rgba(121,200,255,.10)';
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

    drawMap();
    drawNPCs();
    drawPlayer();

    if(paused && !state.win){
      ctx.globalAlpha=0.70;
      ctx.fillStyle='rgba(0,0,0,.45)';
      ctx.fillRect(0,0,window.innerWidth, window.innerHeight);
      ctx.globalAlpha=1;
      ctx.fillStyle='#fff';
      ctx.font='900 34px system-ui';
      ctx.textAlign='center';
      ctx.fillText('PAUSA ‚è∏', window.innerWidth/2, window.innerHeight/2);
      ctx.font='800 14px system-ui';
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.fillText('P o START pa‚Äô seguir', window.innerWidth/2, window.innerHeight/2 + 28);
    }

    drawConfetti();
  }

  // ===== Start/reset =====
  resetGame();
  requestAnimationFrame(loop);

  // ===== Wiring prompt close safety =====
  prompt.addEventListener('click', (e)=>{
    if(e.target === prompt) closePrompt();
  });

})();
</script>
</body>
</html>


