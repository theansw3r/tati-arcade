<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Tati Arcade</title>
  <style>
    :root{
      --bg1:#12062a; --bg2:#2c0750;
      --glass1:rgba(255,255,255,.14); --glass2:rgba(255,255,255,.08);
      --bd:rgba(255,255,255,.18);
      --tx:#fff; --mt:rgba(255,255,255,.78);
      --p:#b86bff; --p2:#ff5cc8; --g:#52ffa8; --y:#ffd36a; --r:#ff5a78;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--tx);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(184,107,255,.25), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(255,92,200,.20), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(82,255,168,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    /* Top HUD */
    .ui{
      position:fixed; left:14px; right:14px; top:14px;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:flex-end;
      pointer-events:none; z-index:10;
    }
    .bar{
      pointer-events:auto;
      padding:10px 12px;
      border-radius:var(--radius);
      background:linear-gradient(180deg, var(--glass1), var(--glass2));
      border:1px solid var(--bd);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--bd);
      background:rgba(0,0,0,.14);
      font-size:12px; color:var(--tx);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(82,255,168,.28); background:rgba(82,255,168,.10); color:#dcffe9}
    .pill.warn{border-color:rgba(255,211,106,.28); background:rgba(255,211,106,.10); color:#ffe7b8}
    .pill.bad{border-color:rgba(255,90,120,.28); background:rgba(255,90,120,.10); color:#ffd7df}
    .btn{
      pointer-events:auto;
      border:none; border-radius:14px;
      padding:10px 12px; font-weight:900; cursor:pointer;
      background:linear-gradient(180deg, rgba(184,107,255,.98), rgba(255,92,200,.85));
      color:#190424;
      transition:filter .12s ease, transform .12s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.ghost{
      background:rgba(255,255,255,.10);
      border:1px solid var(--bd);
      color:var(--tx);
    }

    canvas{
      width:100vw; height:100vh;
      display:block;
      image-rendering: pixelated;
    }

    /* Touch controls (MOBILE-FIRST BIG) */
    .touch{
      position:fixed; left:14px; right:14px; bottom:14px;
      display:flex; justify-content:space-between; gap:14px;
      z-index:20;
      pointer-events:none;
    }
    .joy, .act{pointer-events:auto}
    .joy{
      width:170px; height:170px;
      border-radius:999px;
      border:1px solid var(--bd);
      background:rgba(0,0,0,.16);
      backdrop-filter: blur(10px);
      position:relative;
      touch-action:none;
    }
    .knob{
      width:70px; height:70px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(255,92,200,.85), rgba(184,107,255,.85));
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 12px 26px rgba(0,0,0,.35);
    }
    .act{
      display:flex; flex-direction:column; gap:10px; align-items:flex-end;
    }
    .aBtn{
      width:98px; height:98px; border-radius:24px;
      border:none; cursor:pointer;
      background:linear-gradient(180deg, rgba(82,255,168,.95), rgba(82,255,168,.70));
      color:#062014; font-weight:1000; font-size:18px;
      box-shadow:0 18px 40px rgba(82,255,168,.18);
      touch-action:none;
    }
    .pBtn{
      width:98px; height:44px; border-radius:16px;
      border:1px solid var(--bd);
      background:rgba(255,255,255,.10);
      color:var(--tx); font-weight:900; cursor:pointer;
      touch-action:none;
    }
    @media (min-width: 900px){ .touch{display:none} }

    /* Overlay base */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      padding:18px; z-index:30;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .card{
      width:min(720px,100%);
      border-radius:20px;
      border:1px solid var(--bd);
      background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.10));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:16px;
    }
    .card h1{margin:0; font-size:22px}
    .card p{margin:10px 0 0; color:var(--mt); line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .big{font-size: clamp(22px, 3vw, 34px); margin:0; line-height:1.15}
    .sub{color:var(--mt)}
    ul{margin:10px 0 0 18px}
    li{margin:8px 0}

    /* Confetti canvas */
    #confetti{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:40}
  </style>
</head>
<body>
  <div class="ui">
    <div class="bar">
      <span class="pill" id="lvl">Nivel: 1/3</span>
      <span class="pill warn" id="goal">Objetivo: colecta 5 ‚òÖ</span>
      <span class="pill" id="score">Score: 0</span>
      <span class="pill" id="combo">Combo: x1</span>
      <span class="pill bad" id="hp">HP: 3</span>
      <span class="pill" id="timer">Time: 30.0</span>
      <span class="pill" id="dash">Dash: READY</span>
    </div>
    <div class="bar">
      <button class="btn ghost" id="sound">Sound: OFF</button>
      <button class="btn ghost" id="pause">Pause</button>
      <button class="btn" id="restart">Restart</button>
    </div>
  </div>

  <canvas id="c"></canvas>
  <canvas id="confetti"></canvas>

  <div class="touch" aria-hidden="true">
    <div class="joy" id="joy"><div class="knob" id="knob"></div></div>
    <div class="act">
      <button class="aBtn" id="aBtn">A</button>
      <button class="pBtn" id="pBtn">‚è∏</button>
    </div>
  </div>

  <!-- START OVERLAY -->
  <div class="overlay" id="start">
    <div class="card">
      <h1>üíú Tati Arcade ‚Äî Retro 2D (Mobile)</h1>
      <p>
        Cel: Joystick + bot√≥n <b>A</b><br>
        PC: WASD/Flechas ¬∑ <b>Espacio</b> = Dash/A<br><br>
        Completa 3 niveles. Al final‚Ä¶ hay un PR pendiente üòâ
      </p>
      <div class="row">
        <button class="btn" id="play">Press Start</button>
        <button class="btn ghost" id="how">C√≥mo se gana</button>
      </div>
      <p class="sub" id="howTxt" style="display:none;margin-top:10px">
        Nivel 1: colecta 5 estrellas. Nivel 2: sobrevive + colecta 6. Nivel 3: mini boss + colecta 7.
      </p>
    </div>
  </div>

  <!-- PR OVERLAY -->
  <div class="overlay" id="pr" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div class="pill">Pull Request ‚Äî Girlfriend Mode üíú</div>
          <h2 class="big" style="margin-top:10px;">feat: enable girlfriend_mode()</h2>
          <p class="sub">repo: tati-arcade ¬∑ lucas/heart-branch ‚Üí main</p>
        </div>
        <div class="sub" style="text-align:right">
          Developer: <b>Lucas</b><br>
          Reviewer: <b>Tati</b>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <span class="pill ok">‚úÖ checks passed</span>
        <span class="pill">build: stable</span>
        <span class="pill">latency: low</span>
      </div>

      <p style="margin-top:14px"><b>Mini changelog</b></p>
      <ul>
        <li><b>Added:</b> un feature que se llama ‚Äút√∫‚Äù y me mejora la vida.</li>
        <li><b>Improved:</b> mi mood cuando te veo (sube FPS).</li>
        <li><b>Fixed:</b> d√≠as raros ‚Üí con tu risa se resetean.</li>
      </ul>

      <div class="row" style="margin-top:14px;">
        <button class="btn" id="merge">Merge üíú</button>
        <button class="btn ghost" id="replay">Jugar otra vez</button>
      </div>

      <div id="mergeResult" style="display:none;margin-top:14px">
        <div class="pill ok">üéâ Merged successfully</div>
        <h2 class="big" style="margin-top:10px;">Tati‚Ä¶ ¬øquieres ser mi novia?</h2>
        <p class="sub">‚ÄúAcepto tus bugs y celebro tus versiones.‚Äù</p>
        <div class="row" style="margin-top:12px;">
          <button class="btn" id="yes">S√≠ üíú</button>
          <button class="btn ghost" id="think">D√©jame pensarlo üôà</button>
        </div>
        <p class="sub" id="thinkTxt" style="display:none;margin-top:10px">
          Est√° bien üòå yo espero‚Ä¶ pero ven ac√°, dame un ‚Äúmuak‚Äù primero.
        </p>
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const conf = document.getElementById('confetti');
  const cctx = conf.getContext('2d');

  const ui = {
    lvl: document.getElementById('lvl'),
    goal: document.getElementById('goal'),
    score: document.getElementById('score'),
    combo: document.getElementById('combo'),
    hp: document.getElementById('hp'),
    timer: document.getElementById('timer'),
    dash: document.getElementById('dash'),
    sound: document.getElementById('sound'),
    pause: document.getElementById('pause'),
    restart: document.getElementById('restart')
  };

  const startOv = document.getElementById('start');
  const prOv = document.getElementById('pr');
  const playBtn = document.getElementById('play');
  const howBtn = document.getElementById('how');
  const howTxt = document.getElementById('howTxt');

  const mergeBtn = document.getElementById('merge');
  const replayBtn = document.getElementById('replay');
  const mergeRes = document.getElementById('mergeResult');
  const yesBtn = document.getElementById('yes');
  const thinkBtn = document.getElementById('think');
  const thinkTxt = document.getElementById('thinkTxt');

  // --- Resize
  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    conf.width = Math.floor(window.innerWidth * dpr);
    conf.height = Math.floor(window.innerHeight * dpr);
    cctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  // --- Audio beeps
  let soundOn = false;
  let audioCtx = null;
  function beep(freq=440, dur=0.06, type='square', vol=0.05){
    if(!soundOn) return;
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(), dur*1000);
  }
  ui.sound.addEventListener('click', ()=>{
    soundOn = !soundOn;
    ui.sound.textContent = `Sound: ${soundOn ? 'ON' : 'OFF'}`;
    beep(740,0.08);
  });

  // --- Input
  const keys = {up:false,down:false,left:false,right:false,a:false};
  let paused = false;
  function setKey(name,val){ keys[name]=val; }

  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup'||k==='w') setKey('up',true);
    if(k==='arrowdown'||k==='s') setKey('down',true);
    if(k==='arrowleft'||k==='a') setKey('left',true);
    if(k==='arrowright'||k==='d') setKey('right',true);
    if(k===' ') { setKey('a',true); e.preventDefault(); }
    if(k==='p') paused = !paused;
  });
  window.addEventListener('keyup', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup'||k==='w') setKey('up',false);
    if(k==='arrowdown'||k==='s') setKey('down',false);
    if(k==='arrowleft'||k==='a') setKey('left',false);
    if(k==='arrowright'||k==='d') setKey('right',false);
    if(k===' ') setKey('a',false);
  });

  // Touch joystick
  const joy = document.getElementById('joy');
  const knob = document.getElementById('knob');
  const aBtn = document.getElementById('aBtn');
  const pBtn = document.getElementById('pBtn');

  let joyActive=false, joyId=null;
  let joyVec={x:0,y:0};
  const joyRadius = 64; // BIGGER for mobile

  joy.addEventListener('pointerdown', (e)=>{
    joyActive=true; joyId=e.pointerId; joy.setPointerCapture(joyId);
    moveJoy(e);
  });
  joy.addEventListener('pointermove', (e)=>{ if(joyActive && e.pointerId===joyId) moveJoy(e); });
  joy.addEventListener('pointerup', (e)=>{ if(e.pointerId===joyId) resetJoy(); });
  joy.addEventListener('pointercancel', ()=>resetJoy());

  function moveJoy(e){
    const r = joy.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    const dx = e.clientX - cx;
    const dy = e.clientY - cy;
    const len = Math.hypot(dx,dy) || 1;
    const k = Math.min(1, len/joyRadius);
    joyVec.x = (dx/len)*k;
    joyVec.y = (dy/len)*k;
    knob.style.transform = `translate(calc(-50% + ${joyVec.x*joyRadius}px), calc(-50% + ${joyVec.y*joyRadius}px))`;
  }
  function resetJoy(){
    joyActive=false; joyId=null; joyVec={x:0,y:0};
    knob.style.transform = `translate(-50%,-50%)`;
  }

  aBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); keys.a=true; });
  aBtn.addEventListener('pointerup', (e)=>{ e.preventDefault(); keys.a=false; });
  aBtn.addEventListener('pointercancel', ()=>{ keys.a=false; });

  pBtn.addEventListener('click', ()=>{ paused = !paused; });
  ui.pause.addEventListener('click', ()=>{ paused = !paused; });
  ui.restart.addEventListener('click', ()=>{ startGame(); });

  // --- Game core
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const dist2=(ax,ay,bx,by)=>{const dx=ax-bx,dy=ay-by; return dx*dx+dy*dy};

  let game=null;

  function startGame(){
    mergeRes.style.display='none';
    thinkTxt.style.display='none';
    prOv.style.display='none';
    startOv.style.display='none';
    paused=false;

    game = {
      running:true,
      level:1,
      score:0,
      combo:1,
      hp:3,
      time:30.0,
      got:0,
      need:[5,6,7],
      dashCd:0,
      shake:0,
      particles:[],
      player:{x:160,y:200,r:16,vx:0,vy:0,spd:250,inv:0}, // bigger + tuned
      enemies:[],
      stars:[]
    };
    spawnLevel();
    updateUI();
  }

  function spawnLevel(){
    const g=game;
    g.got=0;
    g.time = 30.0 - (g.level-1)*3;
    g.combo = 1;
    g.player.x = 160; g.player.y = 200; g.player.inv=0;
    g.enemies=[];
    g.stars=[];

    // MOBILE difficulty: fewer enemies, softer speed
    const enemyCount = 4 + g.level*2;
    for(let i=0;i<enemyCount;i++){
      g.enemies.push({
        x:rnd(260, window.innerWidth-40),
        y:rnd(120, window.innerHeight-40),
        r: 12,
        vx:rnd(70,150)*(Math.random()<0.5?-1:1),
        vy:rnd(60,140)*(Math.random()<0.5?-1:1),
        wob: rnd(0.8, 1.4)
      });
    }

    const need = g.need[g.level-1];
    for(let i=0;i<need;i++){
      g.stars.push({x:rnd(260, window.innerWidth-40), y:rnd(120, window.innerHeight-40), r:10, alive:true});
    }

    ui.lvl.textContent = `Nivel: ${g.level}/3`;
    ui.goal.textContent = `Objetivo: colecta ${need} ‚òÖ`;
  }

  function updateUI(){
    const g=game;
    ui.score.textContent = `Score: ${g.score}`;
    ui.combo.textContent = `Combo: x${g.combo}`;
    ui.hp.textContent = `HP: ${g.hp}`;
    ui.timer.textContent = `Time: ${g.time.toFixed(1)}`;

    if(g.dashCd > 0){
      ui.dash.textContent = `Dash: ${g.dashCd.toFixed(1)}s`;
      ui.dash.className = 'pill warn';
    } else {
      ui.dash.textContent = 'Dash: READY';
      ui.dash.className = 'pill ok';
    }
  }

  function particle(x,y,col,n=12){
    for(let i=0;i<n;i++){
      game.particles.push({
        x,y, vx:rnd(-180,180), vy:rnd(-220,120),
        life:rnd(0.35,0.75), r:rnd(2,4), col
      });
    }
  }

  function dash(){
    const g=game;
    if(g.dashCd>0) return;
    g.dashCd=0.9;
    const mv = getMoveVec();
    const len = Math.hypot(mv.x,mv.y) || 1;
    const dx = mv.x/len, dy=mv.y/len;
    g.player.vx += dx*520;
    g.player.vy += dy*520;
    beep(980,0.05,'square',0.05);
    particle(g.player.x,g.player.y,'rgba(255,211,106,.95)',10);
  }

  function hit(){
    const g=game;
    if(g.player.inv>0) return;
    g.hp--;
    g.combo=1;
    g.player.inv=0.9;
    g.shake=0.25;
    beep(220,0.09,'square',0.06);
    particle(g.player.x,g.player.y,'rgba(255,90,120,.95)',16);
    if(g.hp<=0){
      g.running=false;
      showStart("Game Over üòÖ", "Dale restart y la rompes, Tati üíú", "Reintentar");
    }
  }

  function winLevel(){
    const g=game;
    beep(880,0.08,'square',0.05);
    particle(g.player.x,g.player.y,'rgba(82,255,168,.95)',24);
    g.level++;
    if(g.level>3){
      g.running=false;
      prOv.style.display='flex';
      burstConfetti();
      return;
    }
    spawnLevel();
  }

  function showStart(title, text, btnText){
    startOv.style.display='flex';
    document.querySelector('#start h1').textContent = title;
    document.querySelector('#start p').innerHTML = text;
    playBtn.textContent = btnText;
  }

  function getMoveVec(){
    let x=0,y=0;
    if(keys.left) x-=1;
    if(keys.right) x+=1;
    if(keys.up) y-=1;
    if(keys.down) y+=1;

    // add joystick
    x += joyVec.x;
    y += joyVec.y;

    // deadzone (prevents drift)
    const dz = 0.18;
    if(Math.hypot(x,y) < dz) return {x:0,y:0};

    return {x,y};
  }

  // --- Loop
  let last=performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last=now;
    if(game && game.running && !paused){
      step(dt);
    }
    render();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function step(dt){
    const g=game;
    g.time -= dt;
    if(g.time<=0){
      g.running=false;
      showStart("Tiempo üòµ‚Äçüí´", "Se acab√≥ el tiempo. Dale otra, que t√∫ puedes üíú", "Reintentar");
      return;
    }

    if(g.dashCd>0) g.dashCd -= dt;
    if(g.player.inv>0) g.player.inv -= dt;
    if(g.shake>0) g.shake -= dt;

    if(keys.a){ keys.a=false; dash(); }

    const mv=getMoveVec();
    const len=Math.hypot(mv.x,mv.y);
    const nx=len>0?mv.x/len:0;
    const ny=len>0?mv.y/len:0;

    const p=g.player;
    p.vx += nx*p.spd*dt*5;
    p.vy += ny*p.spd*dt*5;
    p.vx *= (1 - 3.2*dt);
    p.vy *= (1 - 3.2*dt);
    p.x += p.vx*dt;
    p.y += p.vy*dt;
    p.x = clamp(p.x, 24, window.innerWidth-24);
    p.y = clamp(p.y, 80, window.innerHeight-24);

    for(const e of g.enemies){
      e.x += e.vx*dt;
      e.y += e.vy*dt;
      e.x += Math.sin(performance.now()*0.002*e.wob)*20*dt;
      e.y += Math.cos(performance.now()*0.002*e.wob)*16*dt;
      if(e.x<240||e.x>window.innerWidth-18) e.vx*=-1;
      if(e.y<90||e.y>window.innerHeight-18) e.vy*=-1;
      if(dist2(p.x,p.y,e.x,e.y) < (p.r+e.r)*(p.r+e.r)) hit();
    }

    const need = g.need[g.level-1];
    for(const s of g.stars){
      if(!s.alive) continue;

      // magnet radius (mobile-friendly)
      const magnet = 18;
      if(dist2(p.x,p.y,s.x,s.y) < (p.r+s.r+magnet)*(p.r+s.r+magnet)){
        s.alive=false;
        g.got++;
        g.score += 100*g.combo;
        g.combo = Math.min(9, g.combo+1);
        beep(740,0.05,'square',0.04);
        particle(s.x,s.y,'rgba(255,211,106,.95)',14);
        if(g.got >= need){
          winLevel();
          return;
        }
      }
    }

    g.particles = g.particles.filter(pt => (pt.life -= dt) > 0);
    for(const pt of g.particles){
      pt.x += pt.vx*dt;
      pt.y += pt.vy*dt;
      pt.vy += 600*dt;
      pt.vx *= (1 - 1.8*dt);
    }

    updateUI();
  }

  function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!game) return;

    const g=game;

    let sx=0, sy=0;
    const rnd = (a,b)=>a+Math.random()*(b-a);
    if(g.shake>0){
      sx = rnd(-6,6) * (g.shake/0.25);
      sy = rnd(-6,6) * (g.shake/0.25);
    }

    ctx.save();
    ctx.translate(sx, sy);

    ctx.globalAlpha = 0.6;
    for(let i=0;i<110;i++){
      const x=(i*173)%window.innerWidth;
      const y=(i*97)%window.innerHeight;
      ctx.fillStyle = (i%9===0) ? 'rgba(255,255,255,.9)' : 'rgba(255,255,255,.5)';
      ctx.fillRect(x,y,2,2);
    }
    ctx.globalAlpha = 1;

    ctx.globalAlpha = 0.28;
    ctx.fillStyle = '#fff';
    ctx.fillRect(220, 0, 2, window.innerHeight);
    ctx.globalAlpha = 1;

    for(const s of g.stars){
      if(!s.alive) continue;
      drawOrb(s.x,s.y,s.r);
    }

    for(const e of g.enemies){
      drawGlitch(e.x,e.y,e.r);
    }

    drawHeart(g.player.x,g.player.y,g.player.r, g.player.inv>0);

    for(const pt of g.particles){
      ctx.fillStyle = pt.col;
      ctx.fillRect(pt.x,pt.y,pt.r,pt.r);
    }

    if(paused && g.running){
      ctx.globalAlpha=0.75;
      ctx.fillStyle='rgba(0,0,0,.45)';
      ctx.fillRect(0,0,window.innerWidth, window.innerHeight);
      ctx.globalAlpha=1;
      ctx.fillStyle='#fff';
      ctx.font='900 40px system-ui';
      ctx.textAlign='center';
      ctx.fillText('PAUSA ‚è∏', window.innerWidth/2, window.innerHeight/2);
      ctx.font='800 16px system-ui';
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.fillText('Presiona ‚è∏ / Pause pa‚Äô seguir', window.innerWidth/2, window.innerHeight/2 + 36);
    }

    ctx.restore();
    drawConfetti();
  }

  function drawHeart(x,y,r,blink){
    const visible = blink ? (Math.floor(performance.now()/100)%2===0) : true;
    if(!visible) return;
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle='rgba(255,92,200,.95)';
    ctx.beginPath();
    ctx.moveTo(0, r*0.75);
    ctx.bezierCurveTo(-r*1.2, -r*0.2, -r*0.4, -r*1.4, 0, -r*0.7);
    ctx.bezierCurveTo(r*0.4, -r*1.4, r*1.2, -r*0.2, 0, r*0.75);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.75)';
    ctx.lineWidth=2;
    ctx.stroke();
    ctx.restore();
  }

  function drawGlitch(x,y,r){
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle='rgba(184,107,255,.22)';
    ctx.strokeStyle='rgba(255,255,255,.35)';
    ctx.lineWidth=2;
    roundRect(-r,-r,r*2,r*2,8,true,true);
    ctx.strokeStyle='rgba(255,92,200,.60)';
    ctx.beginPath();
    ctx.moveTo(-r+2,-r+6); ctx.lineTo(r-2,-r+6);
    ctx.moveTo(-r+2,0); ctx.lineTo(r-10,0);
    ctx.moveTo(-r+2,r-6); ctx.lineTo(r-6,r-6);
    ctx.stroke();
    ctx.restore();
  }

  function drawOrb(x,y,r){
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle='rgba(255,211,106,.22)';
    ctx.strokeStyle='rgba(255,211,106,.65)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(0,0,r,0,Math.PI*2);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle='rgba(255,231,184,.95)';
    ctx.font='900 14px system-ui';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('‚òÖ',0,1);
    ctx.restore();
  }

  function roundRect(x, y, w, h, r, fill, stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y, x+w,y+h, rr);
    ctx.arcTo(x+w,y+h, x,y+h, rr);
    ctx.arcTo(x,y+h, x,y, rr);
    ctx.arcTo(x,y, x+w,y, rr);
    ctx.closePath();
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }

  // Start overlay buttons
  howBtn.addEventListener('click', ()=>{ howTxt.style.display = (howTxt.style.display==='none'?'block':'none'); });
  playBtn.addEventListener('click', ()=>{ startGame(); });

  // PR overlay actions
  replayBtn.addEventListener('click', ()=>{
    startOv.style.display='flex';
    prOv.style.display='none';
    playBtn.textContent='Press Start';
  });
  mergeBtn.addEventListener('click', ()=>{
    mergeRes.style.display='block';
    burstConfetti();
    beep(900,0.08);
  });
  yesBtn.addEventListener('click', ()=>{
    beep(880,0.10);
    alert("üíú Yesss. Girlfriend_mode = true ‚úÖ");
  });
  thinkBtn.addEventListener('click', ()=>{
    thinkTxt.style.display='block';
    beep(520,0.06);
  });

  // Confetti
  let confetti = [];
  function piece(){
    const colors = ['#b86bff','#ff5cc8','#ffffff','#52ffa8','#ffd36a'];
    return {
      x:rnd(0, window.innerWidth),
      y:-20-rnd(0,120),
      vx:rnd(-120,120),
      vy:rnd(140,320),
      r:rnd(6,12),
      rot:rnd(0,Math.PI),
      vr:rnd(-2,2),
      c:colors[Math.floor(rnd(0,colors.length))],
      life:rnd(1.4, 2.6)
    };
  }
  function burstConfetti(){
    confetti = Array.from({length:180}, piece);
  }
  function drawConfetti(){
    if(confetti.length===0) { cctx.clearRect(0,0,window.innerWidth,window.innerHeight); return; }
    cctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    const dt = 1/60;
    confetti.forEach(p=>{
      p.life -= dt;
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 120*dt;
      p.rot += p.vr*dt;
      cctx.save();
      cctx.translate(p.x,p.y);
      cctx.rotate(p.rot);
      cctx.fillStyle = p.c;
      cctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
      cctx.restore();
    });
    confetti = confetti.filter(p=>p.life>0 && p.y < window.innerHeight+40);
  }

  // initial state
  ui.sound.textContent = 'Sound: OFF';
})();
</script>
</body>
</html>

