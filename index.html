<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Tati Arcade ‚Äî Pok√©mon Mode</title>
  <style>
    :root{
      --bg1:#12062a; --bg2:#2c0750;
      --glass1:rgba(255,255,255,.14); --glass2:rgba(255,255,255,.08);
      --bd:rgba(255,255,255,.18);
      --tx:#fff; --mt:rgba(255,255,255,.78);
      --p:#b86bff; --p2:#ff5cc8; --g:#52ffa8; --y:#ffd36a; --r:#ff5a78;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--tx);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(184,107,255,.25), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(255,92,200,.20), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(82,255,168,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    canvas{ width:100vw; height:100vh; display:block; image-rendering: pixelated; }

    /* HUD */
    .ui{
      position:fixed; left:14px; right:14px; top:14px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      z-index:10; pointer-events:none;
    }
    .bar{
      pointer-events:auto;
      padding:10px 12px;
      border-radius:var(--radius);
      background:linear-gradient(180deg, var(--glass1), var(--glass2));
      border:1px solid var(--bd);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--bd);
      background:rgba(0,0,0,.14);
      font-size:12px; color:var(--tx);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(82,255,168,.28); background:rgba(82,255,168,.10); color:#dcffe9}
    .pill.warn{border-color:rgba(255,211,106,.28); background:rgba(255,211,106,.10); color:#ffe7b8}

    .btn{
      pointer-events:auto;
      border:none; border-radius:14px;
      padding:10px 12px; font-weight:900; cursor:pointer;
      background:linear-gradient(180deg, rgba(184,107,255,.98), rgba(255,92,200,.85));
      color:#190424;
    }
    .btn.ghost{
      background:rgba(255,255,255,.10);
      border:1px solid var(--bd);
      color:var(--tx);
    }

    /* Touch controls */
    .touch{
      position:fixed; left:14px; right:14px; bottom:14px;
      display:flex; justify-content:space-between; gap:14px;
      z-index:20; pointer-events:none;
    }
    .joy, .act{pointer-events:auto}
    .joy{
      width:170px; height:170px; border-radius:999px;
      border:1px solid var(--bd);
      background:rgba(0,0,0,.16);
      backdrop-filter: blur(10px);
      position:relative; touch-action:none;
    }
    .knob{
      width:70px; height:70px; border-radius:999px;
      background:linear-gradient(180deg, rgba(255,92,200,.85), rgba(184,107,255,.85));
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 12px 26px rgba(0,0,0,.35);
    }
    .act{display:flex; flex-direction:column; gap:10px; align-items:flex-end;}
    .aBtn{
      width:98px; height:98px; border-radius:24px;
      border:none; cursor:pointer;
      background:linear-gradient(180deg, rgba(82,255,168,.95), rgba(82,255,168,.70));
      color:#062014; font-weight:1000; font-size:18px;
      box-shadow:0 18px 40px rgba(82,255,168,.18);
      touch-action:none;
    }
    .pBtn{
      width:98px; height:44px; border-radius:16px;
      border:1px solid var(--bd);
      background:rgba(255,255,255,.10);
      color:var(--tx); font-weight:900; cursor:pointer;
      touch-action:none;
    }
    @media (min-width: 900px){ .touch{display:none} }

    /* Overlays */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      padding:18px; z-index:30;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .card{
      width:min(780px,100%);
      border-radius:20px;
      border:1px solid var(--bd);
      background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.10));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:16px;
    }
    .card h1{margin:0; font-size:22px}
    .card p{margin:10px 0 0; color:var(--mt); line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .sub{color:var(--mt)}

    /* Dialogue box (Pok√©mon vibe) */
    .dialog{
      position:fixed; left:14px; right:14px; bottom:14px;
      z-index:25;
      border-radius:20px;
      border:1px solid var(--bd);
      background:linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px;
      display:none;
    }
    .dialog .name{font-weight:1000; margin-bottom:6px}
    .dialog .text{color:rgba(255,255,255,.88); line-height:1.4}
    .dialog .hint{margin-top:10px; color:rgba(255,255,255,.68); font-size:12px}

    #confetti{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:40}

    /* ===== WIN SCREEN (pixel vibe) ===== */
    .pixel{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      letter-spacing: .5px;
      text-transform: uppercase;
    }
    .winOverlay{
      position:fixed; inset:0;
      display:none;
      z-index:60;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(6px);
      padding: 18px;
      align-items:center;
      justify-content:center;
    }
    .winCard{
      width:min(520px, 100%);
      border: 4px solid rgba(255,255,255,.85);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      background: #000;
    }
    .winSky{
      position:relative;
      height: 320px;
      background: linear-gradient(#79c8ff, #79c8ff);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .cloud{
      position:absolute;
      width: 92px; height: 36px;
      background: rgba(255,255,255,.92);
      border-radius: 8px;
      opacity:.85;
    }
    .cloud:before, .cloud:after{
      content:"";
      position:absolute;
      background: rgba(255,255,255,.92);
      border-radius: 10px;
    }
    .cloud:before{ width:46px; height:26px; left:-18px; top:10px; }
    .cloud:after{ width:52px; height:28px; right:-16px; top:6px; }
    .c1{ top:34px; left:18px; transform:scale(1.05); }
    .c2{ top:64px; right:22px; transform:scale(.95); }
    .c3{ bottom:88px; left:44px; transform:scale(.9); }

    .winText{
      position:absolute;
      top: 124px;
      left:0; right:0;
      text-align:center;
      font-weight: 1000;
      color: #ffd36a;
      text-shadow: 0 3px 0 rgba(0,0,0,.55);
      font-size: 28px;
    }
    .trophyBtn{
      width: 110px;
      height: 110px;
      border: 4px solid rgba(0,0,0,.35);
      border-radius: 14px;
      background: linear-gradient(180deg, #ffd36a, #ffb84b);
      box-shadow: 0 10px 0 rgba(0,0,0,.25), 0 18px 40px rgba(0,0,0,.25);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      position:absolute;
      top: 34px;
      left:50%;
      transform: translateX(-50%);
      transition: transform .08s ease;
    }
    .trophyBtn:active{ transform: translateX(-50%) scale(.98); }
    .trophyIcon{
      font-size: 56px;
      filter: drop-shadow(0 3px 0 rgba(0,0,0,.25));
    }
    .winGround{
      padding: 14px;
      background: linear-gradient(180deg, rgba(184,107,255,.18), rgba(255,92,200,.10));
      border-top: 4px solid rgba(255,255,255,.35);
    }
    .winHint{
      color: rgba(255,255,255,.90);
      font-weight: 900;
      text-align:center;
      margin: 0;
      font-size: 13px;
    }
    .winModal{
      margin-top: 12px;
      display:none;
      padding: 14px;
      border: 2px dashed rgba(255,255,255,.55);
      border-radius: 14px;
      background: rgba(0,0,0,.35);
    }
    .winQ{
      margin:0;
      color:#fff;
      font-weight:1000;
      font-size: 16px;
      text-align:center;
      text-transform:none;
      letter-spacing:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .winSub{
      margin:10px 0 0;
      text-align:center;
      color: rgba(255,255,255,.75);
      font-size: 12px;
      line-height:1.4;
      text-transform:none;
      letter-spacing:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .winBtns{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .winYes{
      border:none;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:1000;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(184,107,255,.98), rgba(255,92,200,.85));
      color: #190424;
    }
    .winYes:active{ transform: scale(.98); }
    .winClose{
      border:1px solid rgba(255,255,255,.25);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:900;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="ui">
    <div class="bar">
      <span class="pill" id="mode">Modo: Pok√©mon</span>
      <span class="pill warn" id="quest">Quest: 0/3 reliquias</span>
      <span class="pill" id="inv">Inv: ‚Äî</span>
    </div>
    <div class="bar">
      <button class="btn ghost" id="sound">Sound: OFF</button>
      <button class="btn ghost" id="pause">Pause</button>
      <button class="btn" id="restart">Restart</button>
    </div>
  </div>

  <canvas id="c"></canvas>
  <canvas id="confetti"></canvas>

  <div class="dialog" id="dialog">
    <div class="name" id="dName">NPC</div>
    <div class="text" id="dText">Texto‚Ä¶</div>
    <div class="hint" id="dHint">Pulsa A pa‚Äô continuar</div>
  </div>

  <div class="touch" aria-hidden="true">
    <div class="joy" id="joy"><div class="knob" id="knob"></div></div>
    <div class="act">
      <button class="aBtn" id="aBtn">A</button>
      <button class="pBtn" id="pBtn">‚è∏</button>
    </div>
  </div>

  <!-- START OVERLAY -->
  <div class="overlay" id="start">
    <div class="card">
      <h1>üíú Tati Arcade ‚Äî Pok√©mon Mode</h1>
      <p>
        Cel: Joystick + bot√≥n <b>A</b><br>
        Objetivo: consigue <b>3 reliquias</b> y vuelve donde <b>Tati</b> pa‚Äô ganar üèÜ
      </p>
      <div class="row">
        <button class="btn" id="play">Start</button>
        <button class="btn ghost" id="how">C√≥mo jugar</button>
      </div>
      <p class="sub" id="howTxt" style="display:none;margin-top:10px">
        Camina por el mapa. Ac√©rcate a un objeto (brilla) y pulsa A. Habla con NPCs igual.
      </p>
    </div>
  </div>

  <!-- ===== WIN OVERLAY (YOU WIN) ===== -->
  <div class="winOverlay" id="winOverlay">
    <div class="winCard">
      <div class="winSky">
        <div class="cloud c1"></div>
        <div class="cloud c2"></div>
        <div class="cloud c3"></div>

        <button class="trophyBtn" id="trophyBtn" aria-label="Trophy">
          <div class="trophyIcon">üèÜ</div>
        </button>

        <div class="winText pixel">YOU WIN!</div>
      </div>

      <div class="winGround">
        <p class="winHint pixel">TAP THE TROPHY</p>

        <div class="winModal" id="winModal">
          <p class="winQ">Tati‚Ä¶ ¬øquieres ser mi novia?</p>
          <p class="winSub">‚ÄúAcepto tus bugs y celebro tus versiones.‚Äù</p>

          <div class="winBtns">
            <button class="winYes" id="winYes1">S√≠</button>
            <button class="winYes" id="winYes2">S√≠</button>
            <button class="winClose" id="winClose">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const c = document.getElementById('c');
  const ctx = c.getContext('2d');
  const conf = document.getElementById('confetti');
  const cctx = conf.getContext('2d');

  const ui = {
    mode: document.getElementById('mode'),
    quest: document.getElementById('quest'),
    inv: document.getElementById('inv'),
    sound: document.getElementById('sound'),
    pause: document.getElementById('pause'),
    restart: document.getElementById('restart'),
  };

  const startOv = document.getElementById('start');
  const playBtn = document.getElementById('play');
  const howBtn = document.getElementById('how');
  const howTxt = document.getElementById('howTxt');

  const dialog = document.getElementById('dialog');
  const dName = document.getElementById('dName');
  const dText = document.getElementById('dText');
  const dHint = document.getElementById('dHint');

  // Win overlay refs
  const winOverlay = document.getElementById('winOverlay');
  const trophyBtn = document.getElementById('trophyBtn');
  const winModal = document.getElementById('winModal');
  const winYes1 = document.getElementById('winYes1');
  const winYes2 = document.getElementById('winYes2');
  const winClose = document.getElementById('winClose');

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    c.width = Math.floor(window.innerWidth * dpr);
    c.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    conf.width = Math.floor(window.innerWidth * dpr);
    conf.height = Math.floor(window.innerHeight * dpr);
    cctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  // ===== Audio =====
  let soundOn = false;
  let audioCtx = null;
  function beep(freq=440, dur=0.06, type='square', vol=0.05){
    if(!soundOn) return;
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(), dur*1000);
  }
  ui.sound.addEventListener('click', ()=>{
    soundOn = !soundOn;
    ui.sound.textContent = `Sound: ${soundOn ? 'ON' : 'OFF'}`;
    beep(740,0.08);
  });

  // ===== Controls =====
  const keys = {up:false,down:false,left:false,right:false,a:false};
  let paused = false;

  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup'||k==='w') keys.up=true;
    if(k==='arrowdown'||k==='s') keys.down=true;
    if(k==='arrowleft'||k==='a') keys.left=true;
    if(k==='arrowright'||k==='d') keys.right=true;
    if(k===' ') { keys.a=true; e.preventDefault(); }
    if(k==='p') paused = !paused;
  });
  window.addEventListener('keyup', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup'||k==='w') keys.up=false;
    if(k==='arrowdown'||k==='s') keys.down=false;
    if(k==='arrowleft'||k==='a') keys.left=false;
    if(k==='arrowright'||k==='d') keys.right=false;
    if(k===' ') keys.a=false;
  });

  // Touch joystick
  const joy = document.getElementById('joy');
  const knob = document.getElementById('knob');
  const aBtn = document.getElementById('aBtn');
  const pBtn = document.getElementById('pBtn');

  let joyActive=false, joyId=null;
  let joyVec={x:0,y:0};
  const joyRadius = 64;

  joy.addEventListener('pointerdown', (e)=>{
    joyActive=true; joyId=e.pointerId; joy.setPointerCapture(joyId);
    moveJoy(e);
  });
  joy.addEventListener('pointermove', (e)=>{ if(joyActive && e.pointerId===joyId) moveJoy(e); });
  joy.addEventListener('pointerup', (e)=>{ if(e.pointerId===joyId) resetJoy(); });
  joy.addEventListener('pointercancel', ()=>resetJoy());

  function moveJoy(e){
    const r = joy.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    const dx = e.clientX - cx;
    const dy = e.clientY - cy;
    const len = Math.hypot(dx,dy) || 1;
    const k = Math.min(1, len/joyRadius);
    joyVec.x = (dx/len)*k;
    joyVec.y = (dy/len)*k;
    knob.style.transform = `translate(calc(-50% + ${joyVec.x*joyRadius}px), calc(-50% + ${joyVec.y*joyRadius}px))`;
  }
  function resetJoy(){
    joyActive=false; joyId=null; joyVec={x:0,y:0};
    knob.style.transform = `translate(-50%,-50%)`;
  }

  aBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); keys.a=true; });
  aBtn.addEventListener('pointerup', (e)=>{ e.preventDefault(); keys.a=false; });
  aBtn.addEventListener('pointercancel', ()=>{ keys.a=false; });

  ui.pause.addEventListener('click', ()=> paused = !paused);
  pBtn.addEventListener('click', ()=> paused = !paused);
  ui.restart.addEventListener('click', ()=> startGame());

  // ===== Map (tile-based) =====
  const TILE = 28;
  const MAP_W = 28;
  const MAP_H = 18;

  const map = [];
  for(let y=0;y<MAP_H;y++){
    const row=[];
    for(let x=0;x<MAP_W;x++){
      let t=0;
      const border = (x===0||y===0||x===MAP_W-1||y===MAP_H-1);
      if(border) t=1;
      if((x===10 && y>2 && y<14) || (y===7 && x>3 && x<24)) t=1;
      if(!t && ((x+y)%11===0 || (x*y)%29===0)) t=2;
      row.push(t);
    }
    map.push(row);
  }
  map[7][15]=0; map[7][16]=0; map[7][17]=0;

  function isWall(tx,ty){
    if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) return true;
    return map[ty][tx]===1;
  }

  // ===== Helpers =====
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const dist=(ax,ay,bx,by)=>Math.hypot(ax-bx, ay-by);

  // ===== Game State =====
  let game=null;

  function startGame(){
    startOv.style.display='none';
    dialog.style.display='none';
    winOverlay.style.display='none';
    winModal.style.display='none';
    paused=false;

    game = {
      running:true,
      cam:{x:0,y:0},
      player:{x:3*TILE, y:3*TILE, spd:160, face:'down'},
      inventory:[],
      questReadyToWin:false,
      dialogQueue:[],
      canInteract:true,
      aLatch:false,
      npcs:[
        {
          id:'tati',
          name:'Tati',
          x:24*TILE, y:4*TILE,
          lines:[
            "Lucas‚Ä¶ te tengo una quest. üëÄ",
            "Tr√°eme 3 reliquias: üíú, ‚≠ê y üçì.",
            "Cuando vuelvas‚Ä¶ te tengo una sorpresa üòâ"
          ]
        },
        {
          id:'sign1',
          name:'Letrero',
          x:5*TILE, y:14*TILE,
          lines:[
            "Tip: Ac√©rcate a lo que brille y pulsa A.",
            "Si te pierdes, busca el camino con menos paredes."
          ]
        }
      ],
      items:[
        {id:'heart', icon:'üíú', name:'Reliquia Morada', x:6*TILE, y:5*TILE, taken:false},
        {id:'star',  icon:'‚≠ê', name:'Estrella', x:20*TILE, y:13*TILE, taken:false},
        {id:'berry', icon:'üçì', name:'Berry', x:25*TILE, y:15*TILE, taken:false},
      ],
    };

    updateHUD();
  }

  function updateHUD(){
    const got = game.inventory.length;
    ui.quest.textContent = `Quest: ${got}/3 reliquias`;
    ui.inv.textContent = `Inv: ${game.inventory.length? game.inventory.map(i=>i.icon).join(' ') : '‚Äî'}`;
  }

  // ===== Dialogue =====
  function openDialog(name, lines){
    game.dialogQueue = lines.slice();
    dName.textContent = name;
    dHint.textContent = "Pulsa A pa‚Äô continuar";
    dialog.style.display='block';
    nextDialogLine();
  }
  function nextDialogLine(){
    const line = game.dialogQueue.shift();
    if(!line){
      dialog.style.display='none';
      game.canInteract = true;
      return;
    }
    dText.textContent = line;
    beep(660,0.03,'square',0.03);
  }

  // ===== Particles =====
  const parts=[];
  function particleBurst(x,y){
    for(let i=0;i<16;i++){
      parts.push({
        x,y, vx:rnd(-140,140), vy:rnd(-190,90),
        life:rnd(0.35,0.7), r:rnd(2,4),
        c: ['rgba(184,107,255,.95)','rgba(255,92,200,.95)','rgba(255,211,106,.95)','rgba(82,255,168,.95)'][Math.floor(rnd(0,4))]
      });
    }
  }

  // ===== Confetti =====
  let confetti = [];
  function piece(){
    const colors = ['#b86bff','#ff5cc8','#ffffff','#52ffa8','#ffd36a'];
    return {
      x:rnd(0, window.innerWidth),
      y:-20-rnd(0,120),
      vx:rnd(-120,120),
      vy:rnd(140,320),
      r:rnd(6,12),
      rot:rnd(0,Math.PI),
      vr:rnd(-2,2),
      c:colors[Math.floor(rnd(0,colors.length))],
      life:rnd(1.4, 2.6)
    };
  }
  function burstConfetti(){
    confetti = Array.from({length:180}, piece);
  }
  function drawConfetti(){
    if(confetti.length===0) { cctx.clearRect(0,0,window.innerWidth,window.innerHeight); return; }
    cctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    const dt = 1/60;
    confetti.forEach(p=>{
      p.life -= dt;
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 120*dt;
      p.rot += p.vr*dt;
      cctx.save();
      cctx.translate(p.x,p.y);
      cctx.rotate(p.rot);
      cctx.fillStyle = p.c;
      cctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
      cctx.restore();
    });
    confetti = confetti.filter(p=>p.life>0 && p.y < window.innerHeight+40);
  }

  // ===== WIN SCREEN =====
  function showWin(){
    paused = true;
    winModal.style.display = 'none';
    winOverlay.style.display = 'flex';
    burstConfetti();
    beep(880,0.08);
  }
  function hideWin(){
    winOverlay.style.display = 'none';
    winModal.style.display = 'none';
  }

  trophyBtn.addEventListener('click', ()=>{
    winModal.style.display = (winModal.style.display === 'block') ? 'none' : 'block';
    beep(740,0.06);
  });

  function yesAction(){
    burstConfetti();
    beep(980,0.10);
    alert("üíú Girlfriend_mode = true ‚úÖ");
  }
  winYes1.addEventListener('click', yesAction);
  winYes2.addEventListener('click', yesAction);
  winClose.addEventListener('click', hideWin);

  // ===== Interaction =====
  function tryInteract(){
    if(!game.canInteract) return;

    const p = game.player;

    // if dialog open, A advances
    if(dialog.style.display==='block'){
      nextDialogLine();
      return;
    }

    // nearest NPC
    const npc = game.npcs.find(n => dist(p.x,p.y,n.x,n.y) < 24);
    if(npc){
      game.canInteract = false;

      // If it's Tati and all items are collected ‚Üí WIN
      if(npc.id==='tati' && game.inventory.length===3){
        openDialog("Tati", [
          "Ok‚Ä¶ veo que completaste la quest. ‚úÖ",
          "Ahora s√≠‚Ä¶ reclama tu trofeo üèÜ"
        ]);
        game.questReadyToWin = true;
        return;
      }

      openDialog(npc.name, npc.lines);
      return;
    }

    // nearest item
    const it = game.items.find(i => !i.taken && dist(p.x,p.y,i.x,i.y) < 22);
    if(it){
      it.taken = true;
      game.inventory.push(it);
      updateHUD();
      particleBurst(it.x, it.y);
      beep(740,0.06,'square',0.05);

      game.canInteract = false;
      openDialog("Sistema", [
        `Obtuviste: ${it.icon} ${it.name}`,
        (game.inventory.length<3)
          ? "Sigue buscando‚Ä¶ te faltan reliquias."
          : "¬°Listo! Vuelve donde Tati pa‚Äô ganar."
      ]);
      return;
    }
  }

  // ===== Movement + Collision =====
  function getMoveVec(){
    let x=0,y=0;
    if(keys.left) x-=1;
    if(keys.right) x+=1;
    if(keys.up) y-=1;
    if(keys.down) y+=1;
    x += joyVec.x;
    y += joyVec.y;

    const dz = 0.18;
    if(Math.hypot(x,y) < dz) return {x:0,y:0};
    const len = Math.hypot(x,y);
    return {x:x/len, y:y/len};
  }

  function movePlayer(dt){
    const p = game.player;
    const mv = getMoveVec();
    const spd = p.spd;

    if(mv.x===0 && mv.y===0) return;

    if(Math.abs(mv.x) > Math.abs(mv.y)) p.face = (mv.x>0?'right':'left');
    else p.face = (mv.y>0?'down':'up');

    let nx = p.x + mv.x*spd*dt;
    let ny = p.y + mv.y*spd*dt;

    const r = 9;
    function collides(px,py){
      const corners = [
        {x:px-r,y:py-r},{x:px+r,y:py-r},{x:px-r,y:py+r},{x:px+r,y:py+r}
      ];
      return corners.some(c=>{
        const tx = Math.floor(c.x / TILE);
        const ty = Math.floor(c.y / TILE);
        return isWall(tx,ty);
      });
    }

    if(!collides(nx, p.y)) p.x = nx;
    if(!collides(p.x, ny)) p.y = ny;

    p.x = clamp(p.x, TILE*1.2, TILE*(MAP_W-1.2));
    p.y = clamp(p.y, TILE*1.2, TILE*(MAP_H-1.2));
  }

  // ===== Camera =====
  function updateCamera(){
    const p = game.player;
    const targetX = p.x - window.innerWidth/2;
    const targetY = p.y - window.innerHeight/2;
    const maxX = MAP_W*TILE - window.innerWidth;
    const maxY = MAP_H*TILE - window.innerHeight;
    game.cam.x = clamp(targetX, 0, Math.max(0,maxX));
    game.cam.y = clamp(targetY, 0, Math.max(0,maxY));
  }

  // ===== Render helpers =====
  function roundRect(x, y, w, h, r, fill, stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y, x+w,y+h, rr);
    ctx.arcTo(x+w,y+h, x,y+h, rr);
    ctx.arcTo(x,y+h, x,y, rr);
    ctx.arcTo(x,y, x+w,y, rr);
    ctx.closePath();
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }

  function drawMap(){
    const cam = game.cam;
    const startX = Math.floor(cam.x / TILE);
    const startY = Math.floor(cam.y / TILE);
    const endX = Math.ceil((cam.x + window.innerWidth) / TILE);
    const endY = Math.ceil((cam.y + window.innerHeight) / TILE);

    for(let y=startY; y<endY; y++){
      for(let x=startX; x<endX; x++){
        if(x<0||y<0||x>=MAP_W||y>=MAP_H) continue;
        const t = map[y][x];
        const sx = x*TILE - cam.x;
        const sy = y*TILE - cam.y;

        if(t===1){
          ctx.fillStyle = 'rgba(255,255,255,.10)';
          ctx.fillRect(sx,sy,TILE,TILE);
          ctx.strokeStyle = 'rgba(255,255,255,.14)';
          ctx.strokeRect(sx+0.5,sy+0.5,TILE-1,TILE-1);
        }else if(t===2){
          ctx.fillStyle = 'rgba(184,107,255,.06)';
          ctx.fillRect(sx,sy,TILE,TILE);
        }else{
          ctx.fillStyle = 'rgba(0,0,0,.08)';
          ctx.fillRect(sx,sy,TILE,TILE);
        }
      }
    }
  }

  function drawItems(){
    const cam=game.cam;
    for(const it of game.items){
      if(it.taken) continue;
      const sx = it.x - cam.x;
      const sy = it.y - cam.y;

      ctx.globalAlpha = 0.45 + 0.25*Math.sin(performance.now()*0.006);
      ctx.fillStyle = 'rgba(255,211,106,.25)';
      ctx.beginPath();
      ctx.arc(sx, sy, 18, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.font = '20px system-ui';
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillText(it.icon, sx, sy);
    }
  }

  function drawEntity(x,y,isTati){
    const cam=game.cam;
    const sx = x - cam.x;
    const sy = y - cam.y;

    ctx.fillStyle = isTati ? 'rgba(184,107,255,.35)' : 'rgba(255,255,255,.10)';
    roundRect(sx-12, sy-14, 24, 28, 8, true, false);

    ctx.font = '18px system-ui';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.fillText(isTati?'üíú':'‚ÑπÔ∏è', sx, sy+1);
  }

  function drawNPCs(){
    for(const n of game.npcs){
      const isTati = n.id==='tati';
      drawEntity(n.x, n.y, isTati);

      const p=game.player;
      if(dist(p.x,p.y,n.x,n.y) < 52){
        const cam=game.cam;
        const sx = n.x - cam.x;
        const sy = n.y - cam.y;
        ctx.font='12px system-ui';
        ctx.textAlign='center';
        ctx.fillStyle='rgba(255,255,255,.85)';
        ctx.fillText(n.name, sx, sy-24);
      }
    }
  }

  function drawPlayer(){
    const p=game.player;
    const cam=game.cam;
    const sx = p.x - cam.x;
    const sy = p.y - cam.y;

    ctx.fillStyle='rgba(0,0,0,.25)';
    ctx.beginPath();
    ctx.ellipse(sx, sy+12, 12, 6, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle='rgba(255,92,200,.90)';
    roundRect(sx-12, sy-16, 24, 32, 9, true, false);

    ctx.fillStyle='rgba(255,255,255,.85)';
    const fx = p.face==='right'? 6 : p.face==='left'? -6 : 0;
    const fy = p.face==='down'? 6 : p.face==='up'? -6 : 0;
    ctx.beginPath();
    ctx.arc(sx+fx, sy-2+fy, 3, 0, Math.PI*2);
    ctx.fill();
  }

  function drawParticles(dt){
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i];
      p.life -= dt;
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 540*dt;
      p.vx *= (1 - 1.6*dt);

      const cam=game.cam;
      ctx.fillStyle=p.c;
      ctx.fillRect(p.x-cam.x, p.y-cam.y, p.r, p.r);

      if(p.life<=0) parts.splice(i,1);
    }
  }

  // ===== Loop =====
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;

    if(game && game.running && !paused){
      if(keys.a && !game.aLatch){
        game.aLatch = true;
        tryInteract();
      }
      if(!keys.a) game.aLatch = false;

      movePlayer(dt);
      updateCamera();

      // If quest ready and dialog just closed ‚Üí show YOU WIN
      if(game.questReadyToWin && dialog.style.display==='none'){
        game.questReadyToWin = false;
        showWin();
      }
    }

    render(dt);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function render(dt){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    ctx.globalAlpha = 0.55;
    for(let i=0;i<90;i++){
      const x=(i*173)%window.innerWidth;
      const y=(i*97)%window.innerHeight;
      ctx.fillStyle = (i%9===0) ? 'rgba(255,255,255,.9)' : 'rgba(255,255,255,.5)';
      ctx.fillRect(x,y,2,2);
    }
    ctx.globalAlpha = 1;

    if(!game) { drawConfetti(); return; }

    drawMap();
    drawItems();
    drawNPCs();
    drawPlayer();
    drawParticles(dt);

    if(paused){
      ctx.globalAlpha=0.70;
      ctx.fillStyle='rgba(0,0,0,.45)';
      ctx.fillRect(0,0,window.innerWidth, window.innerHeight);
      ctx.globalAlpha=1;
      ctx.fillStyle='#fff';
      ctx.font='900 36px system-ui';
      ctx.textAlign='center';
      ctx.fillText('PAUSA ‚è∏', window.innerWidth/2, window.innerHeight/2);
      ctx.font='800 14px system-ui';
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.fillText('Dale ‚è∏ / Pause pa‚Äô seguir', window.innerWidth/2, window.innerHeight/2 + 28);
    }

    drawConfetti();
  }

  // ===== UI wiring =====
  howBtn.addEventListener('click', ()=>{ howTxt.style.display = (howTxt.style.display==='none'?'block':'none'); });
  playBtn.addEventListener('click', ()=> startGame());

  // Init
  ui.sound.textContent = 'Sound: OFF';
})();
</script>
</body>
</html>
